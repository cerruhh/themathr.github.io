<!doctype html>
<html>
<head>
    <style>
        * {
            background-color: black;
            color: #00dd00;
            font-family: "Courier New";
            font-size: 100%;
        }

        body {
            margin-left: 2%
        }

        input {
            border: none;
            width: 90%;
        }

        input:focus {
            outline: none;
        }
    </style>
</head>
<body>
</body>
<script>
    const version = '0.3-1';
    const user_agent = window.navigator.userAgent;

    // webterm rem
    let echo_enabled = true
    const skip_boot_splash = true

    const filesystem = {
        'name': '',
        'type': 'directory',
        'content': {}
    };
    filesystem.parent = filesystem;

    function create_file(type, name, content, path) {
        if (path === ".") {
            path = current_path;
        }
        parent = get_file(path);
        if (!parent || parent.type != 'directory') return false;
        parent.content[name] = {
            'name': name,
            'type': type,
            'content': content,
            'parent': parent
        };
        return true;
    }

    function delete_file(path) {
        let file = get_file(path);
        let parent = file.parent;
        console.log(file.parent);
        delete parent.content[file.name];
        return true;
    }

    function create_cmd(name, func) {
        create_file('command', name, func, "/cmd");
        return true
    }

    function split(str, sep) {
        return str.split(sep); //TODO
    }

    function get_file(path) {
        let cur = filesystem;
        let err = false;
        split(path, '/').forEach((v) => {
            if (!v) return;
            if (cur == undefined || cur.type != 'directory') {
                err = true;
                return;
            }
            if (v == '..') {
                cur = cur.parent;
            } else {
                cur = cur.content[v];
            }
        });
        if (err) return undefined;
        return cur;
    }

    function get_path(file) {
        let path = file.name;
        let cur = file.parent;
        while (cur != filesystem) {
            path = cur.name + '/' + path;
            cur = cur.parent;
        }
        return '/' + path;
    }

    function get_time() {
        let date = new Date();
        return date.getDay() + ' ' + date.getDate() + '.' + date.getMonth() + '.' + date.getFullYear() + '.' + date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds() + ' ' + date.getMilliseconds();
    }

    function get_full_uname() {
        return 'CrADOS ' + get_time() + ' +0000' + 'x69_64 C-CoreUtils + CrADOS';
    }

    function set_font_size(font_size) {
        document.body.style.fontSize = font_size + '%';
    }

    create_file('directory', 'cmd', {}, '/');
    create_file('text', 'README', 'how can you read that?', '/');
    create_file('command', 'help', '(args)=>{print("help - Shows help\\necho - Repeat arguments\\nls - Look at directory content\\ncd - Move between directoires\\nmkdir - Create a directory\\n about - Return information about the system","yellow");}', '/cmd');
    create_file('command', 'echo', '(args)=>{args.shift();print(args.join(" "), "white");}', '/cmd');



    // create_file('command', 'ls', '(args)=>{\
    // let path = args[1];\
    // if (!path) path = current_path;\
    // let directory = get_file(path);\
    // if (!directory) {print("This directory doesn\'t exist.","red");return;}\
    // if (directory.type != "directory") {print("This target is not a directory.","red");return;}\
    // Object.entries(directory.content).forEach(([k, v]) => {print(k+"\\n", v.type=="directory"?"cyan":"white")});\
    // }', '/cmd');

    // COMMANDS_ALL_FUNCS
    // LS


    function list_files(args) {
        let path = args[1];
        if (!path) path = current_path;
        let directory = get_file(path);
        if (!directory) {print("This directory doesn't exist.","red");return;}
        if (directory.type !== "directory") {print("This target is not a directory.","red");return;}
        Object.entries(directory.content).forEach(([k, v]) => {print(k+"\n", v.type==="directory"?"cyan":"white")});
    }

    function verbose_list_files(args) {
        let path = args[1];
        if (!path) path = current_path;
        let directory = get_file(path);
        if (!directory) {print("This directory doesn't exist.","red");return;}
        if (directory.type !== "directory") {print("This target is not a directory.","red");return;}
        Object.entries(directory.content).forEach(([k, v]) => {
            print(k+ " - " + v.type +"\n", v.type==="directory"?"cyan":"white")
        });
    }

    function chdir(args) {
        let path = args[1];
        if (!path) {current_path="/";return;}
        let directory = get_file(current_path + "/" + path);
        if (!directory){print("This directory doesn't exist.","red");return;}
        if (directory.type !== "directory") {print("This target is not a directory.","red");return;}
        current_path=get_path(directory);
    }

    function mkdir(args) {
        let path = args[1];
        if (!path) return;
        path = split(path, "/");
        let name = path.pop();
        path = current_path+"/"+path.join("/");
        if (!create_file("directory",name,{},path)) print("Could not create directory.", "red")
    }

    function about_crados(args) {
        print("<b>CrADOS - the Crappy And Disappointing Operating System</b>", "lime");
        print('Version ' + version + ' - Copyright Aberlure Technologies 1970-20254¨£%R4G5Vsf34T\nThis system contains no secret.\n');
    }

    function get_useragent(args) {
        print(user_agent, "lime");
    }

    function whoami(args) {
        print("WORKGROUP/guest", "white");
    }

    function uname_bin(args) {
        print(get_full_uname(), "white")
    }

    function date_bin(args) {
        print(get_time() + " +0000", "white")
    }

    function print_working_dir(args) {
        print(current_path, "white")
    }

    function shell_bin(args) {
        if (args[1] === "fontsize") {
            if (args[2] === undefined) {
                print("fontsize not specified!", "red");
                return false;
            }
            set_font_size(args[2]);
            return true;
        }
        if (args[1] === "clear") {
            clear();
            return true;
        }
        if (args[1] === "input") {
            if (args[2] === "1") {
                echo_enabled = true;
                return true
            }
            if (args[2] === "0") {
                echo_enabled = false;
                return true
            }
            print("invalid echo value", "red");
            return false;
        }
    }

    function bin_create_file(args) {
        // function create_file(type, name, content, path) {
        if (args[1] === "/?") {
            print("fnew command structure\n", "white");
            print("fnew FILE_CONTENT FILE_NAME FILE_PATH\n");
            return 1;
        }

        if (args[1] !== undefined && args[2] !== undefined && args[3] !== undefined) {
            let file = create_file("text", args[2], args[1], args[3]);
            if (!file) {
                print("File creation error.", "red");
                return 2;
            }
            let fileloc = args[3]
            if (args[3] === "" || args[3] === ".") {
                fileloc = current_path
            }

            print("file created at location: " + fileloc);
            print("file operation completed successfully!\n", "white");
            return 1;
        } else {
            print("Not all args filled!\n");
        }
    }

    function bin_read_file(args) {
        if (args[1] !== undefined) {
            let read_path = args[1]
            if (args[1].charAt(0) !== "/" && current_path !== "/") {
                read_path = current_path + "/" + read_path
            }
            console.log(read_path)
            let readopen = get_file(read_path)
            if (readopen === undefined) {
                print("File not found", "red")
                return false
            }

            if (readopen.type === "directory") {
                print("Cannot read type directory", "red");
                return false;
            }


            console.log(readopen.content.toString())
            print(readopen.content.toString(), "white")
            if (args[2] === "/A") {
                print("\n")
                print("File opened at location " + read_path + "\n", "white")
                print("File type: " + readopen.type + "\n", "white")
                print("File name: " + readopen.name + "\n", "white")
            }

            return true
        }
    }

    function fdel(args) {
        if (args[1] === "/?") {
            print("Usage:\n", "white");
            print("fdel FILEPATH");
            return true;
        }
        if (args[1] === undefined) {
            print("invalid path", "red");
            return false
        }
        let preserve_root = args[2] === "/NPR"
        if (preserve_root === false && get_file(args[1].charAt(0)) === "/") {
            print("WARNING: Attempted to remove root!", "orange");
            print("To del root, add /NPR to the command!", "white");
            return false;
        }

        let remove_file = get_file(args[1])
        if (remove_file === undefined) {
            print("file not found.", "red");
            return false;
        }
        console.log(remove_file)
        let file_action = delete_file(get_path(remove_file));

        if (file_action === true) {
            const fitype = remove_file.type.toString()
            print("Successfully removed " + fitype + " " + remove_file.name, "white");
            return true;
        } else {
            print("File error.", "red");
            return false;
        }
    }

    function changetype(args) {
        if (args[1] === undefined || args[2] === undefined) {
            return false;
        }
        let file_path = args[1]
        if (file_path.charAt(0) !== "/") {
            file_path = current_path + "/" + args[1]
        }



        let file = get_file(file_path)
        if (file === undefined) {
            print("file not found.", "red");
            return false;
        }

        file.type = args[2];
        print("File " + file.name + " is now of type " + args[2], "white");
        return true;
    }

    create_cmd("ls", list_files);

    // specls
    create_cmd("lsla", verbose_list_files);
    create_cmd("cd", chdir);
    create_cmd("mkdir", mkdir);
    create_cmd("about", about_crados);
    create_cmd("get_useragent", get_useragent);


    // cerruhh's coreutil commands
    create_cmd("whoami", whoami);
    create_cmd("uname", uname_bin);
    create_cmd("date", date_bin);
    create_cmd("pwd", print_working_dir);

    // file utils
    create_cmd("fnew", bin_create_file);
    create_cmd("fread", bin_read_file);
    create_cmd("fdel", fdel);
    create_cmd("chtype", changetype);

    // create_file('command', 'pkgman', '(args)=>{\
    // if (args[1] == "update" and args[2] == "--details"){print("Failed to connect to crs://packs.crados.os/packages/packagecheck", "white");};\
    // if (args[1] == "update"){print("Connection failed, exiting", "white");}',
    // '/cmd')

    create_cmd("shell", shell_bin);

    let current_path = '/';

    const body = document.body;
    const input = "$ <input id='inp' autofocus onkeydown=\"if (event.key=='Enter') {execute();}\"></input>";

    function focus() {
        const inp = document.getElementById('inp');
        if (!inp) return;
        inp.focus();
    }
    window.onclick = focus;

    function print(text, color=null) {
        let toWrite = text.replaceAll('\n','<br>');
        if (color) toWrite = "<div style='color: " + color + ";'>" + toWrite + "</div>";
        body.innerHTML += toWrite;
    }

    function clear() {
        body.innerHTML = "";
    }

    function execute() {
        const inp = body.children[body.children.length-1];
        const txt = inp.value;
        let allow_eval = true
        if (txt === "..") {
            allow_eval = false
        }
        if (!txt) return;
        inp.remove();
        body.appendChild(document.createTextNode(txt));
        body.innerHTML += "<br>";

        const cmd = split(txt.replaceAll(/\s+/g, ' '), ' ');

        let command = get_file('/cmd/'+cmd[0]);
        if (command && allow_eval) {
            eval(command.content)(cmd);
        } else {
            print('Command not found.', 'red');
        }

        body.innerHTML += current_path + input;
        focus();
    }

    const messages = [
        'Booting up... ',
        '====','============','======','=================','=<br>',
        'Doing various complicated stuff...<br>',
        '<div style="color: orange;">[WARNING] User who created this shell might be stupid</div>',
        'Loading shell...<br>',
        '<div style="color: green;">[OK] Loaded coreutils</div><br>',
        '<div style="color: orange;">[WARN] No pkgman repositories loaded!</div><br>'
    ];

    const delays = [0,
        500,
        100,520,230,721,50,
        500,100,700,
        30,700
    ];

    let timedMsgIndex = 0;
    function timedMessage() {
        setTimeout(() => {
            if (timedMsgIndex >= messages.length) {
                body.innerHTML = " \
            <b>CrADOS " + version + " (C) Aberlure Technologies</b><br> \
            Type \"help\" for help.<br> \
            /"+input;
                body.children[body.children.length-1].focus();
                return;
            }
            body.innerHTML += messages[timedMsgIndex];
            timedMsgIndex++;
            timedMessage();
        }, delays[timedMsgIndex]);
    }
    if (skip_boot_splash) {
        for (let i = 0; i < delays.length; i++) {
            delays[i] = 0;
            //Do something
        }    }

    timedMessage();
</script>
</html>
